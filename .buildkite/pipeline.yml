steps:
  - label: "Julia {{matrix.version}} -- {{matrix.benchmark}} -- {{matrix.category}}"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
    plugins:
      - vchuravy/polarsignals:
          cloud_token: "eyJhbGciOiJFZERTQSJ9.eyJhdWQiOiJmYjRkM2Y1ZC1lMGQ1LTRmODMtYTg4Yy1mMDNhNWE1ZmE4ODkiLCJpYXQiOjE2ODUxMjY3MjkzODIxNzEzMDcsImlzcyI6Imh0dHBzOi8vYXBpLnBvbGFyc2lnbmFscy5jb20vIiwianRpIjoiMDQxYTZhMGEtYWMxNi00Njk1LThjZjUtN2RjMzNhZmRhMzFlIiwicHJvamVjdElkIjoiZmI0ZDNmNWQtZTBkNS00ZjgzLWE4OGMtZjAzYTVhNWZhODg5IiwidmVyc2lvbiI6IjEuMC4wIiwid3JpdGVQcm9maWxlcyI6dHJ1ZX0.70Hjge3rHdWRP7-M3sgkH44JT1QYphN8ekuqx51RbYN2HFAlndGZqnmhT_X96ZpANb5DLM3jAEgvWpHuFnayAg"

    matrix:
      setup:
        version:
          - "nightly"
        benchmark:
          - "serial"
          - "multithreaded"
        category:
          - "all"
      adjustments:
        #  - with:
        #     version: "nightly"
        #     benchmark: "slow"
        #     category: "rb_tree"
         - with:
            version: "nightly"
            benchmark: "slow"
            category: "bigint"
    agents:
      queue: "juliaecosystem"
      arch: "x86_64"
      os: "linux"
    commands: |
      echo "--- Instantiate"
      julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build()'

      echo "+++ Run benchmarks {{matrix.benchmark}}"
      julia --threads=auto --project=. run_benchmarks.jl {{matrix.benchmark}} {{matrix.category}}
    artifact_paths:
      - "results.csv"

    if: build.message !~ /\[skip tests\]/
    timeout_in_minutes: 60